<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Bible Verse Ordering Game</title>
  <style>
    :root{
      --text:#e5e7eb; --sub:#9ca3af;
      --shadow: 0 14px 40px rgba(0,0,0,.35);
      --r: 18px;

      --verse-font: 14px;
      --verse-meta-font: 12px;

      --accent:#38bdf8;
      --fixed-bg: rgba(56,189,248,.14);
      --fixed-line: rgba(56,189,248,.55);
      --fixed-badge-bg: rgba(56,189,248,.16);
      --fixed-badge-line: rgba(56,189,248,.45);

      --card-bg: rgba(15,23,42,.95);
      --item-bg: rgba(2,6,23,.45);
      --line: rgba(31,41,55,.85);
    }
    *{box-sizing:border-box}
    body{
      margin:0; padding:16px;
      background:linear-gradient(180deg,#0b1120,#020617);
      color:var(--text);
      font-family:system-ui,-apple-system,"Apple SD Gothic Neo","Noto Sans KR",sans-serif;
    }
    .wrap{max-width:1100px;margin:0 auto}
    h1{margin:0 0 12px;font-size:20px}

    .screen{display:none}
    .screen.active{display:block}

    .grid{display:grid;gap:12px;grid-template-columns:1fr}
    @media(min-width:980px){
      .grid{grid-template-columns: 420px 1fr;}
    }

    .card{
      background:var(--card-bg);
      border:1px solid var(--line);
      border-radius:var(--r);
      padding:14px;
      box-shadow:var(--shadow);
    }
    .sectionTitle{
      font-size:14px;
      color:#bae6fd;
      margin:0 0 10px;
    }
    label{display:block;font-size:12px;color:var(--sub);margin:10px 0 6px}
    select,button{
      width:100%;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(31,41,55,.9);
      background:#0b1223;
      color:var(--text);
      font-size:14px;
    }
    button{cursor:pointer}
    button.primary{background:rgba(56,189,248,.14); border-color:rgba(56,189,248,.38)}
    button.ghost{background:transparent}
    button:disabled{opacity:.55; cursor:not-allowed}

    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row > button{flex:1 1 140px}

    /* Game screen */
    .refLine{font-size:14px;color:#e0f2fe;margin:0 0 10px}
    .list{display:flex;flex-direction:column;gap:10px;margin-top:8px}

    .item{
      display:flex; gap:10px; align-items:flex-start;
      border:1px solid var(--line);
      background:var(--item-bg);
      border-radius:16px;
      padding:12px;
      position:relative;
    }

    /* Fixed-first-verse visual highlight (v04) */
    .item.fixedVerse{
      background:linear-gradient(180deg, var(--fixed-bg), rgba(2,6,23,.35));
      border-color: var(--fixed-line);
      box-shadow: 0 0 0 2px rgba(56,189,248,.18) inset;
    }
    .fixedBadge{
      position:absolute;
      top:10px;
      right:10px;
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      background: var(--fixed-badge-bg);
      border:1px solid var(--fixed-badge-line);
      color:#bae6fd;
      font-size:12px;
      line-height:1;
      user-select:none;
      white-space:nowrap;
    }
    .fixedBadge .lock{
      font-size:12px;
      line-height:1;
    }

    .ctrl{
      display:flex; flex-direction:column; gap:8px; align-items:center;
      flex:0 0 auto;
      width:44px;
    }
    .ctrl.hidden{visibility:hidden}
    .ctrl button{
      width:40px;
      padding:6px 0;
      border-radius:12px;
      background:rgba(56,189,248,.10);
      border:1px solid rgba(56,189,248,.30);
      font-size:14px;
    }
    .text{font-size:var(--verse-font);line-height:1.6;word-break:keep-all}
    .meta{font-size:var(--verse-meta-font);color:var(--sub);margin-bottom:6px}

    /* Bottom bar fixed â€” must stay one line (no wrap) */
    .bottomBar{
      position:fixed;
      left:0; right:0; bottom:0;
      padding:10px 12px calc(10px + env(safe-area-inset-bottom));
      background:rgba(2,6,23,.92);
      border-top:1px solid rgba(31,41,55,.85);
      backdrop-filter: blur(8px);
      z-index:500;
    }
    .barInner{
      max-width:1100px;
      margin:0 auto;
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:nowrap;         /* one line only */
      overflow-x:auto;          /* if very narrow, allow horizontal scroll but keep one line */
      -webkit-overflow-scrolling: touch;
    }
    .barInner::-webkit-scrollbar{height:0}
    .barInner button{
      width:auto;
      flex:0 0 auto;            /* prevent wrapping */
      white-space:nowrap;
      padding:10px 10px;
      font-size:13px;
      border-radius:14px;
      min-width:92px;
    }
    .padBottom{padding-bottom:92px;}

    /* Modal */
    .modalOverlay{
      position:fixed; inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:999;
    }
    .modal{
      width:min(760px, 100%);
      background:rgba(15,23,42,.98);
      border:1px solid rgba(31,41,55,.9);
      border-radius:20px;
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .modalHeader{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      padding:12px 14px;
      border-bottom:1px solid rgba(31,41,55,.85);
      background:rgba(2,6,23,.35);
    }
    .modalTitle{margin:0;font-size:15px;color:#bae6fd}
    .modalBody{padding:14px}
    .modalFooter{
      padding:12px 14px;
      border-top:1px solid rgba(31,41,55,.85);
      background:rgba(2,6,23,.35);
      display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;
    }
    .closeBtn{
      width:auto;
      padding:8px 10px;
      border-radius:12px;
      background:transparent;
    }
    .resultBadge{
      display:inline-block;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.25);
      font-size:13px;
      margin-bottom:10px;
    }
    .success{border-color:rgba(34,197,94,.5); color:#bbf7d0; background:rgba(34,197,94,.12)}
    .fail{border-color:rgba(239,68,68,.5); color:#fecaca; background:rgba(239,68,68,.12)}
    .warn{border-color:rgba(245,158,11,.5); color:#fde68a; background:rgba(245,158,11,.12)}

    .answerLine{
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(31,41,55,.75);
      background:rgba(2,6,23,.35);
      margin-bottom:10px;
    }
    .answerLine:last-child{margin-bottom:0}
  </style>
</head>

<body>
<div class="wrap">
  <h1>Bible Verse Ordering Game</h1>

  <!-- Screen 1 -->
  <section id="screen1" class="screen active">
    <div class="grid">
      <div class="card">
        <div class="sectionTitle">Selection</div>

        <label>ê¶Œ (Book)</label>
        <select id="bookSel"></select>

        <label>ì¥ (Chapter)</label>
        <select id="chapSel"></select>

        <label>ì ˆ (Verse)</label>
        <select id="verseSel"></select>

        <div style="height:14px"></div>

        <div class="sectionTitle">Command</div>
        <div class="row">
          <button class="primary" id="startBtn">ê²Œì„ ì‹œì‘</button>
          <button id="settingsBtn">ê²Œì„ ì„¤ì •</button>
        </div>
      </div>

      <div class="card"><div class="sectionTitle"> </div></div>
    </div>
  </section>

  <!-- Screen 2 -->
  <section id="screen2" class="screen">
    <div class="card padBottom">
      <div class="sectionTitle">Game</div>
      <p class="refLine" id="refTitle"></p>
      <div class="list" id="list"></div>
    </div>
  </section>
</div>

<!-- Bottom bar (Screen 2 only) -->
<div class="bottomBar" id="bottomBar" style="display:none">
  <div class="barInner">
    <button id="checkBtn">ê²°ê³¼ í™•ì¸</button>
    <button class="ghost" id="retryBtn">ë‹¤ì‹œí•˜ê¸°</button>
    <button class="ghost" id="answerBtn">ì •ë‹µ í™•ì¸</button>
    <button class="primary" id="nextBtn">ë‹¤ìŒ ì´ë™</button>
    <button id="returnBtn">ëŒì•„ê°€ê¸°</button>
  </div>
</div>

<!-- MODALS -->
<div class="modalOverlay" id="overlay">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modalHeader">
      <h2 class="modalTitle" id="modalTitle">Popup</h2>
      <button class="closeBtn" id="modalClose">ë‹«ê¸°</button>
    </div>
    <div class="modalBody" id="modalBody"></div>
    <div class="modalFooter" id="modalFooter"></div>
  </div>
</div>

<script>
/* =========================================================
   index_v04.html (requirement v04)
   - Screen2: ì²« êµ¬ì ˆ(ì‹œì‘ ì ˆ) ê³ ì • + ì‹œê°ì  í•˜ì´ë¼ì´íŠ¸ + â–²/â–¼ ì—†ìŒ
   - Screen2: ë‚˜ë¨¸ì§€ êµ¬ì ˆ(2ë²ˆì§¸~)ì—ë§Œ â–²/â–¼ ì¡´ì¬
   - Bottom bar one line: ê²°ê³¼/ë‹¤ì‹œ/ì •ë‹µ/ë‹¤ìŒ/ëŒì•„ê°€ê¸°
   - ë‹¤ìŒ ì´ë™: ë‹¤ìŒ Nì„¸íŠ¸ â†’ ì¥ ëì´ë©´ ë‹¤ìŒ ì¥ 1ì ˆ â†’ ë‹¤ìŒ ì¥ ì—†ìœ¼ë©´ Screen1
   - ìƒíƒœ ì €ì¥: ê²Œì„ ì‹œì‘ / ë‹¤ìŒ ì´ë™ / ì„¤ì • ì €ì¥
   - ì €ì¥ í‚¤: bible_game_state_v01
========================================================= */

const STORAGE_KEY = "bible_game_state_v01";

let RAW = null;
let BIBLE = null;

let settings = { n: 5 };
let sel = { book:null, chap:null, verse:null };

let correctSet = [];   // [fixed, ...movableCorrect]
let shuffled = [];     // [fixed, ...movableShuffled]

/* DOM */
const $ = (id)=>document.getElementById(id);

const screen1 = $("screen1");
const screen2 = $("screen2");
const bottomBar = $("bottomBar");

const bookSel = $("bookSel");
const chapSel = $("chapSel");
const verseSel = $("verseSel");

const startBtn = $("startBtn");
const settingsBtn = $("settingsBtn");

const checkBtn = $("checkBtn");
const retryBtn = $("retryBtn");
const answerBtn = $("answerBtn");
const nextBtn = $("nextBtn");
const returnBtn = $("returnBtn");

const refTitle = $("refTitle");
const listEl = $("list");

/* Modal */
const overlay = $("overlay");
const modalTitle = $("modalTitle");
const modalBody = $("modalBody");
const modalFooter = $("modalFooter");
const modalClose = $("modalClose");

/* ===== Modal Helpers ===== */
function openModal(title, bodyHtml, footerButtons=[]) {
  modalTitle.textContent = title;
  modalBody.innerHTML = bodyHtml;
  modalFooter.innerHTML = "";
  for (const btn of footerButtons) modalFooter.appendChild(btn);
  overlay.style.display = "flex";
}
function closeModal() {
  overlay.style.display = "none";
  modalBody.innerHTML = "";
  modalFooter.innerHTML = "";
}
modalClose.addEventListener("click", closeModal);
overlay.addEventListener("click", (e)=>{ if(e.target === overlay) closeModal(); });

function mkButton(text, cls, onClick) {
  const b = document.createElement("button");
  b.textContent = text;
  if (cls) b.className = cls;
  b.style.width = "auto";
  b.addEventListener("click", onClick);
  return b;
}
function escapeHtml(s){
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function openAlert(msg, title="ì•Œë¦¼"){
  const body = `
    <div class="resultBadge warn">ì•Œë¦¼</div>
    <div style="color:var(--sub);line-height:1.6">${escapeHtml(msg).replaceAll("\n","<br/>")}</div>
  `;
  const okBtn = mkButton("í™•ì¸", "primary", closeModal);
  openModal(title, body, [okBtn]);
}

/* ===== Screen Navigation ===== */
function goScreen(n){
  if(n === 1){
    screen1.classList.add("active");
    screen2.classList.remove("active");
    bottomBar.style.display = "none";
    window.scrollTo({top:0, behavior:"instant"});
  }else{
    screen1.classList.remove("active");
    screen2.classList.add("active");
    bottomBar.style.display = "block";
    window.scrollTo({top:0, behavior:"instant"});
  }
}

/* ===== Data Load + Normalize ===== */
function normalizeBibleJson(raw){
  if (raw && typeof raw === "object" && raw.chapters && (raw.book_name_kr || raw.book_name)) {
    const name = raw.book_name_kr || raw.book_name;
    return { [name]: raw.chapters };
  }
  if (raw && typeof raw === "object" && !Array.isArray(raw) && !raw.chapters) {
    return raw;
  }
  return null;
}

async function loadData(){
  if (location.protocol === "file:") {
    openAlert("file:// ë¡œëŠ” verse_krv.jsonì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\nGitHub Pages ë˜ëŠ” ë¡œì»¬ ì„œë²„ë¡œ ì‹¤í–‰í•˜ì„¸ìš”.");
    return false;
  }

  try{
    const res = await fetch("./verse_krv.json", { cache:"no-store" });
    if(!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
    const text = await res.text();
    RAW = JSON.parse(text);
    BIBLE = normalizeBibleJson(RAW);
    if(!BIBLE || Object.keys(BIBLE).length === 0) throw new Error("Normalized bible is empty.");
    return true;
  }catch(e){
    console.error("Failed to load verse_krv.json:", e);
    openAlert(
      "verse_krv.json ë¡œë“œ ì‹¤íŒ¨\n\n" +
      "1) index_v04.htmlê³¼ ê°™ì€ í´ë”ì¸ì§€\n" +
      "2) /verse_krv.jsonì´ ì—´ë¦¬ëŠ”ì§€\n" +
      "3) JSON ë¬¸ë²• ì˜¤ë¥˜ê°€ ì—†ëŠ”ì§€\n\n" +
      `ì˜¤ë¥˜: ${String(e)}`
    );
    return false;
  }
}

/* ===== Select Fill ===== */
function fillSelect(el, items, placeholder){
  el.innerHTML = "";
  if(!items || items.length === 0){
    const opt = document.createElement("option");
    opt.value = "";
    opt.textContent = placeholder || "ì—†ìŒ";
    el.appendChild(opt);
    return;
  }
  for(const v of items){
    const opt = document.createElement("option");
    opt.value = v;
    opt.textContent = v;
    el.appendChild(opt);
  }
}

function getBooks(){ return Object.keys(BIBLE || {}); }
function getChapters(book){
  const ch = (BIBLE && BIBLE[book]) ? Object.keys(BIBLE[book]) : [];
  return ch.sort((a,b)=>Number(a)-Number(b));
}
function getVerses(book, chap){
  const obj = (BIBLE && BIBLE[book] && BIBLE[book][chap]) ? BIBLE[book][chap] : {};
  const vs = Object.keys(obj);
  return vs.sort((a,b)=>Number(a)-Number(b));
}

function initSelectors(){
  fillSelect(bookSel, getBooks(), "ê¶Œ ì—†ìŒ");

  bookSel.onchange = ()=>{ sel.book = bookSel.value; updateChapters(); };
  chapSel.onchange = ()=>{ sel.chap = chapSel.value; updateVerses(); };
  verseSel.onchange = ()=>{ sel.verse = verseSel.value; };

  sel.book = bookSel.value;
  updateChapters();
}
function updateChapters(){
  fillSelect(chapSel, getChapters(bookSel.value), "ì¥ ì—†ìŒ");
  sel.chap = chapSel.value;
  updateVerses();
}
function updateVerses(){
  fillSelect(verseSel, getVerses(bookSel.value, chapSel.value), "ì ˆ ì—†ìŒ");
  sel.verse = verseSel.value;
}

/* ===== Dynamic Font by N ===== */
function applyDynamicFontByN(n){
  const clamped = Math.max(5, Math.min(10, Number(n)));
  const font = 15 - (clamped - 5) * (3/5);
  const meta = 12 - (clamped - 5) * (1/5);
  document.documentElement.style.setProperty("--verse-font", `${font.toFixed(2)}px`);
  document.documentElement.style.setProperty("--verse-meta-font", `${meta.toFixed(2)}px`);
  settings.n = clamped;
}

/* ===== Game Build ===== */
function buildConsecutiveSet(book, chap, startVerse, n){
  const verses = getVerses(book, chap).map(v=>Number(v));
  const start = Number(startVerse);
  const startIdx = verses.indexOf(start);
  if(startIdx < 0) return null;

  const slice = verses.slice(startIdx, startIdx + n); // ì¥ ëì´ë©´ ë” ì ì„ ìˆ˜ ìˆìŒ
  if(slice.length === 0) return null;

  const chapterObj = BIBLE[book][chap];
  return slice.map((v,i)=>({
    id: `${book}|${chap}|${v}`,
    book, chap, verse: String(v),
    ref: `${book} ${chap}:${v}`,
    text: (chapterObj[String(v)] ?? "").trim(),
    orderIndex: i
  }));
}

function shuffleArray(arr){
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]] = [a[j],a[i]];
  }
  return a;
}

/* ===== Render ===== */
function renderList(){
  listEl.innerHTML = "";
  for(let idx=0; idx<shuffled.length; idx++){
    const it = shuffled[idx];
    const row = document.createElement("div");
    row.className = "item";
    row.dataset.id = it.id;

    const isFixed = (idx === 0);
    if(isFixed){
      row.classList.add("fixedVerse");
      const badge = document.createElement("div");
      badge.className = "fixedBadge";
      badge.innerHTML = `<span class="lock">ğŸ”’</span><span>ì‹œì‘ ì ˆ ê³ ì •</span>`;
      row.appendChild(badge);
    }

    const ctrl = document.createElement("div");
    ctrl.className = "ctrl";

    if(isFixed){
      // ì²« êµ¬ì ˆì€ â–²/â–¼ ë²„íŠ¼ ì—†ìŒ (ì•„ì˜ˆ ìˆ¨ê¹€)
      ctrl.classList.add("hidden");
    }else{
      const up = document.createElement("button");
      up.type = "button";
      up.textContent = "â–²";
      up.disabled = (idx === 1); // ê³ ì • êµ¬ì ˆ ìœ„ë¡œëŠ” ëª» ì˜¬ë¼ê°
      up.addEventListener("click", ()=> moveByIndex(idx, -1));

      const down = document.createElement("button");
      down.type = "button";
      down.textContent = "â–¼";
      down.disabled = (idx === shuffled.length - 1);
      down.addEventListener("click", ()=> moveByIndex(idx, +1));

      ctrl.appendChild(up);
      ctrl.appendChild(down);
    }

    const content = document.createElement("div");
    content.style.flex = "1 1 auto";

    // (ì„ íƒ) ì°¸ì¡°ë¥¼ ì•„ì£¼ ì‘ê²Œ í‘œì‹œ â€” ì„¤ëª…ì´ ì•„ë‹ˆë¼ ì½˜í…ì¸  ì°¸ì¡°
    const meta = document.createElement("div");
    meta.className = "meta";
    meta.textContent = it.ref;

    const text = document.createElement("div");
    text.className = "text";
    text.textContent = it.text || "";

    content.appendChild(meta);
    content.appendChild(text);

    row.appendChild(ctrl);
    row.appendChild(content);
    listEl.appendChild(row);
  }
}

function moveByIndex(idx, dir){
  // idxëŠ” 1 ì´ìƒë§Œ í—ˆìš©(0ì€ ê³ ì •)
  if(idx <= 0) return;
  const j = idx + dir;
  if(j <= 0) return; // ê³ ì • êµ¬ì ˆê³¼ ìŠ¤ì™‘ ê¸ˆì§€
  if(j >= shuffled.length) return;

  [shuffled[idx], shuffled[j]] = [shuffled[j], shuffled[idx]];
  renderList();
}

/* ===== Correctness ===== */
function isCorrectOrder(){
  if(shuffled.length !== correctSet.length) return false;
  // ì²« êµ¬ì ˆ(ê³ ì •)ì€ ë°˜ë“œì‹œ ë™ì¼
  if(shuffled[0]?.id !== correctSet[0]?.id) return false;
  // ë‚˜ë¨¸ì§€ ìˆœì„œ ë¹„êµ
  for(let i=1;i<shuffled.length;i++){
    if(shuffled[i].id !== correctSet[i].id) return false;
  }
  return true;
}

/* ===== Persistence ===== */
function savePlayState(){
  try{
    const payload = { book: sel.book, chap: sel.chap, verse: sel.verse, n: settings.n };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
  }catch(e){}
}
function loadPlayState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return null;
    const obj = JSON.parse(raw);
    if(!obj || !obj.book || !obj.chap || !obj.verse) return null;
    return obj;
  }catch(e){
    return null;
  }
}
function applyStateToSelectors(state){
  if(!BIBLE) return false;
  if(!(state.book in BIBLE)) return false;
  if(!(state.chap in BIBLE[state.book])) return false;
  if(!(state.verse in BIBLE[state.book][state.chap])) return false;

  const n = Number(state.n);
  if(Number.isFinite(n)) applyDynamicFontByN(n);

  bookSel.value = state.book;
  sel.book = state.book;

  updateChapters();
  chapSel.value = state.chap;
  sel.chap = state.chap;

  updateVerses();
  verseSel.value = state.verse;
  sel.verse = state.verse;

  return true;
}

/* ===== Popups ===== */
function openSettings(){
  const body = `
    <div class="resultBadge warn">ê²Œì„ ì„¤ì •</div>
    <div style="display:grid;grid-template-columns:160px 1fr;gap:10px;align-items:center">
      <div style="color:var(--sub);font-size:13px">ì—°ì† êµ¬ì ˆ ìˆ˜ (N)</div>
      <div>
        <select id="nSel">
          ${[5,6,7,8,9,10].map(v=>`<option value="${v}" ${v===settings.n?"selected":""}>${v}</option>`).join("")}
        </select>
      </div>
    </div>
  `;
  const cancelBtn = mkButton("ì·¨ì†Œ", "", closeModal);
  const saveBtn = mkButton("ì €ì¥", "primary", ()=>{
    const nSel = document.getElementById("nSel");
    const n = Number(nSel?.value ?? 5);
    applyDynamicFontByN(n);
    savePlayState(); // ì„¤ì • ì €ì¥ ì‹œ ì €ì¥
    closeModal();
  });
  openModal("ê²Œì„ ì„¤ì •", body, [cancelBtn, saveBtn]);
}

function openResult(){
  if(!correctSet.length) return;
  const ok = isCorrectOrder();
  const badge = ok
    ? `<div class="resultBadge success">PASS</div>`
    : `<div class="resultBadge fail">FAIL</div>`;
  const closeBtn = mkButton("ë‹«ê¸°", "primary", closeModal);
  openModal("ê²Œì„ ê²°ê³¼", badge, [closeBtn]);
}

function openAnswer(){
  if(!correctSet.length) return;
  const lines = correctSet.map(v=>`
    <div class="answerLine">
      <div class="meta">${escapeHtml(v.ref)}</div>
      <div class="text">${escapeHtml(v.text || "")}</div>
    </div>
  `).join("");
  const closeBtn = mkButton("ë‹«ê¸°", "primary", closeModal);
  openModal("ì •ë‹µ", lines, [closeBtn]);
}

/* ===== Game Actions ===== */
function startGame(){
  sel.book = bookSel.value;
  sel.chap = chapSel.value;
  sel.verse = verseSel.value;

  const set = buildConsecutiveSet(sel.book, sel.chap, sel.verse, settings.n);
  if(!set) return;

  // ì²« êµ¬ì ˆ ê³ ì •: ì…”í”Œì€ 2ë²ˆì§¸ ì´í›„ë§Œ
  correctSet = set;
  const fixed = set[0];
  const movableCorrect = set.slice(1);
  const movableShuffled = shuffleArray(movableCorrect);
  shuffled = [fixed, ...movableShuffled];

  const start = Number(sel.verse);
  const endVerse = Number(set[set.length-1].verse);
  refTitle.textContent = `${sel.book} ${sel.chap}:${start} ~ ${sel.book} ${sel.chap}:${endVerse}`;

  renderList();
  savePlayState();  // ê²Œì„ ì‹œì‘ ì‹œ ì €ì¥
  goScreen(2);
}

function retry(){
  if(!correctSet.length) return;
  const fixed = correctSet[0];
  const movableCorrect = correctSet.slice(1);
  const movableShuffled = shuffleArray(movableCorrect);
  shuffled = [fixed, ...movableShuffled];
  renderList();
}

function goToSelectionScreen(){
  goScreen(1);
}

/* ë‹¤ìŒ ì´ë™:
   1) ê°™ì€ ì¥ì—ì„œ nextStart = currentStart + Nì´ ì¡´ì¬í•˜ë©´ ì´ë™
   2) ì—†ìœ¼ë©´ ë‹¤ìŒ ì¥(ê°™ì€ ê¶Œ)ìœ¼ë¡œ ì´ë™, ì‹œì‘ ì ˆì€ ê·¸ ì¥ì˜ ì²« ì ˆ
   3) ë‹¤ìŒ ì¥ì´ ì—†ìœ¼ë©´ Screen1ìœ¼ë¡œ ì´ë™
*/
function nextMove(){
  if(!correctSet.length) return;

  const book = sel.book;
  const chap = sel.chap;
  const currentStart = Number(sel.verse);
  const nextStart = currentStart + settings.n;

  const versesThisChap = getVerses(book, chap).map(v=>Number(v));
  const hasNextSectionInSameChap = versesThisChap.includes(nextStart);

  if(hasNextSectionInSameChap){
    verseSel.value = String(nextStart);
    sel.verse = String(nextStart);

    const set = buildConsecutiveSet(book, chap, sel.verse, settings.n);
    if(!set) return;

    correctSet = set;
    const fixed = set[0];
    const movableCorrect = set.slice(1);
    shuffled = [fixed, ...shuffleArray(movableCorrect)];

    const endVerse = Number(set[set.length-1].verse);
    refTitle.textContent = `${book} ${chap}:${nextStart} ~ ${book} ${chap}:${endVerse}`;

    renderList();
    savePlayState(); // ë‹¤ìŒ ì´ë™ ì‹œ ì €ì¥
    return;
  }

  // move to next chapter
  const chapters = getChapters(book).map(c=>Number(c));
  const chapNum = Number(chap);
  const nextChapNum = chapters.find(c=>c > chapNum);

  if(nextChapNum === undefined){
    // no next chapter
    goToSelectionScreen();
    return;
  }

  const nextChap = String(nextChapNum);
  const versesNextChap = getVerses(book, nextChap);
  if(!versesNextChap.length){
    // chapter exists but empty -> return screen1
    goToSelectionScreen();
    return;
  }

  const firstVerse = versesNextChap[0];

  // update selectors state
  chapSel.value = nextChap;
  sel.chap = nextChap;

  updateVerses();
  verseSel.value = firstVerse;
  sel.verse = firstVerse;

  const set = buildConsecutiveSet(book, nextChap, firstVerse, settings.n);
  if(!set) return;

  correctSet = set;
  const fixed = set[0];
  const movableCorrect = set.slice(1);
  shuffled = [fixed, ...shuffleArray(movableCorrect)];

  const endVerse = Number(set[set.length-1].verse);
  refTitle.textContent = `${book} ${nextChap}:${Number(firstVerse)} ~ ${book} ${nextChap}:${endVerse}`;

  renderList();
  savePlayState(); // ë‹¤ìŒ ì´ë™(ì¥ ì´ë™ í¬í•¨) ì‹œ ì €ì¥
}

/* Wiring */
startBtn.addEventListener("click", startGame);
settingsBtn.addEventListener("click", openSettings);

checkBtn.addEventListener("click", openResult);
retryBtn.addEventListener("click", retry);
answerBtn.addEventListener("click", openAnswer);
nextBtn.addEventListener("click", nextMove);
returnBtn.addEventListener("click", goToSelectionScreen);

/* Boot */
(async function boot(){
  applyDynamicFontByN(settings.n);

  const ok = await loadData();
  if(!ok) return;

  initSelectors();

  const state = loadPlayState();
  if(state) applyStateToSelectors(state);
})();
</script>
</body>
</html>
